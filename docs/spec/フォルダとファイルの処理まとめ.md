# フォルダとファイルの処理まとめ（Next.js App Router）

- ルート（`src/app`）
  - `layout.tsx`: 全ページ共通のレイアウト（ヘッダー/フッター）。サーバーコンポーネント。
  - `page.tsx`: `/` ルートのページ。サーバーコンポーネント（RSC）。
  - `loading.tsx`/`error.tsx`/`not-found.tsx`: ローディング/エラー/404（省略時は未使用）。

- ページディレクトリ（例）
  - `src/app/generate/page.tsx`: `/generate` ページ。クライアント側で OpenAI 生成を呼ぶ UI。
  - `src/app/editor/page.tsx`: `/editor` 新規作成ページ（RSC → Client Editor）。
  - `src/app/editor/[id]/page.tsx`: 動的ページ `/editor/:id`。URL パラメータ `id` をページの `params` で受ける。
  - `src/app/my/arts/page.tsx`: `/my/arts` 一覧（RSC）。
  - `src/app/art/[id]/page.tsx`: `/art/:id` 詳細（RSC）。
  - `src/app/auth/sign-in/page.tsx`: サインインページ（RSC）。

- API ルート（Route Handlers）
  - `src/app/api/generate/route.ts`: `/api/generate` のハンドラ。`export async function POST()` を実装。
  - `src/app/api/metrics/route.ts`: `/api/metrics` のハンドラ。`export async function GET()` を実装。
  - `src/app/api/auth/[...nextauth]/route.ts`: `/api/auth/*` を NextAuth に委譲する動的キャッチオール。

- ミドルウェア
  - `src/middleware.ts`: 認証保護（matcher 指定）。`/editor` と `/my/arts` をサインイン必須にする。

- サーバーアクション
  - `src/app/actions/pixelArt.ts`: Editor 保存/CRUD 用のサーバーアクション。フォームから `useActionState` で呼ぶ。

- ライブラリ
  - `src/lib/` 配下: 認証設定、Prisma、OpenAI、ストレージ、Zod スキーマ、ログ、レート制限などの共通処理。

- public 配下
  - `public/uploads`: ローカルストレージドライバの出力先。`/uploads/...` として静的配信される。

- ルーティング規則（簡易）
  - ディレクトリ: URL パスに対応（`app/foo` → `/foo`）。
  - 動的セグメント: `[id]` は `/foo/:id` に対応。キャッチオール `[...any]` は `/foo/*` を受ける。
  - ファイル: `page.tsx` はページ、`route.ts` は API、`layout.tsx` はレイアウト。

- データ取得
  - RSC（サーバー）: 直接 DB（Prisma）や `getServerSession` が使える。
  - クライアント: `use client` を宣言し、ブラウザ API を使用。サーバー処理は API 経由で呼ぶ。

- 認証
- NextAuth（Google Provider）。`/api/auth/*` を NextAuth に委譲。
  - `middleware.ts` で保護パスを設定、未認証時は `/auth/sign-in` へ。

このまとめは `AGENTS.md` の「プロジェクト構成」節と対応しています。コード内の先頭コメントにも同様の説明を追記しています。
